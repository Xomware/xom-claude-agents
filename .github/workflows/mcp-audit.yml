name: MCP Tool Discipline Audit

on:
  pull_request:
    paths:
      - "agents/**/agent.yaml"
      - "agents/**/tools.yaml"
      - "scripts/mcp-audit.sh"

jobs:
  mcp-audit:
    name: Audit MCP Tool Counts
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Make audit script executable
        run: chmod +x scripts/mcp-audit.sh

      - name: Run MCP audit (JSON report)
        id: audit
        run: |
          set +e
          REPORT=$(./scripts/mcp-audit.sh --report)
          EXIT_CODE=$?
          echo "report<<EOF" >> "$GITHUB_OUTPUT"
          echo "$REPORT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          exit 0  # Don't fail here â€” we post the comment first

      - name: Run MCP audit (table for comment)
        id: audit_table
        run: |
          set +e
          TABLE=$(./scripts/mcp-audit.sh 2>&1)
          echo "table<<EOF" >> "$GITHUB_OUTPUT"
          echo "$TABLE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Parse violation count
        id: parse
        run: |
          VIOLATIONS=$(echo '${{ steps.audit.outputs.report }}' | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('violations',0))")
          echo "violations=$VIOLATIONS" >> "$GITHUB_OUTPUT"

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const violations = parseInt('${{ steps.parse.outputs.violations }}', 10);
            const table = `${{ steps.audit_table.outputs.table }}`;
            const report = `${{ steps.audit.outputs.report }}`;

            const statusIcon = violations > 0 ? 'âŒ' : 'âœ…';
            const statusText = violations > 0
              ? `**${violations} violation(s) found** â€” agents exceed the 10-tool limit.`
              : '**All agents are within the 10-tool limit.**';

            const body = [
              `## ${statusIcon} MCP Tool Discipline Audit`,
              '',
              statusText,
              '',
              '### Agent Table',
              '```',
              table,
              '```',
              '',
              '<details>',
              '<summary>ðŸ“Š Full JSON Report</summary>',
              '',
              '```json',
              report,
              '```',
              '</details>',
              '',
              violations > 0
                ? '### How to Fix\nRun `./scripts/mcp-audit.sh --fix` locally to auto-disable excess tools, then commit the result.'
                : '',
              '',
              `*Generated by [mcp-audit.sh](../blob/${context.sha}/scripts/mcp-audit.sh) Â· Max tools per agent: 10*`
            ].join('\n');

            // Find existing bot comment to update rather than spam
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('MCP Tool Discipline Audit')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Fail if violations found
        if: steps.parse.outputs.violations != '0'
        run: |
          echo "::error::MCP audit failed: ${{ steps.parse.outputs.violations }} agent(s) exceed the 10-tool limit."
          echo "Run ./scripts/mcp-audit.sh --fix to auto-remediate, or manually reduce enabled tools."
          exit 1
